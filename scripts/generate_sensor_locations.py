"""Generate sensor-locations.json using REAL METR-LA sensor coordinates
from the DCRNN dataset and actual graph adjacency from adj_METR-LA.pkl.

This produces a JSON with:
  - sensors[]: real lat/lng coordinates + speed/congestion from HDF5
  - edges[]:   adjacency graph edges (filtered for physical proximity)
"""
import numpy as np, h5py, json, os, pickle

# ── 1. Load speed data from HDF5 ──────────────────────────────────────────
h5 = h5py.File("data/raw/METR-LA.h5", "r")
key = list(h5.keys())[0]
block = h5[key]
speed = np.array(block.get("values", block.get("block0_values")), dtype=np.float32)
h5.close()
n_timesteps, n_sensors = speed.shape
print(f"Loaded speed data: {n_timesteps} timesteps × {n_sensors} sensors")

speed[speed == 0] = np.nan
mean_speed = np.nan_to_num(np.nanmean(speed, axis=0), nan=50.0)
smin, smax = mean_speed.min(), mean_speed.max()
congestion = 1.0 - (mean_speed - smin) / (smax - smin + 1e-6)

# ── 2. Load adjacency graph ───────────────────────────────────────────────
with open("data/raw/adj_METR-LA.pkl", "rb") as f:
    adj_data = pickle.load(f, encoding="latin1")
sensor_ids = adj_data[0]   # list of 207 sensor ID strings
adj = adj_data[2]           # 207×207 weighted adjacency matrix
np.fill_diagonal(adj, 0)

# ── 3. Real METR-LA sensor coordinates (from DCRNN graph_sensor_locations.csv) ─
# Format: {sensor_id: (lat, lng)}
REAL_COORDS = {
    "773869": (34.15497, -118.31829), "767541": (34.11621, -118.23799),
    "767542": (34.11641, -118.23819), "717447": (34.07248, -118.26772),
    "717446": (34.07142, -118.26572), "717445": (34.06913, -118.25932),
    "773062": (34.05368, -118.23369), "767620": (34.13486, -118.22932),
    "737529": (34.20264, -118.47352), "717816": (34.15562, -118.46860),
    "765604": (34.16415, -118.38223), "767471": (34.15691, -118.22469),
    "716339": (34.07821, -118.28795), "773906": (34.15660, -118.30266),
    "765273": (34.18949, -118.47437), "716331": (34.07006, -118.26246),
    "771667": (34.07314, -118.23388), "716337": (34.07732, -118.28186),
    "769953": (34.20672, -118.19992), "769402": (34.12095, -118.33911),
    "769403": (34.12073, -118.33928), "769819": (34.20584, -118.19803),
    "769405": (34.12634, -118.34482), "716941": (34.05767, -118.21435),
    "717578": (34.15478, -118.27076), "716960": (34.12121, -118.27164),
    "717804": (34.09478, -118.47605), "767572": (34.12967, -118.22871),
    "767573": (34.12964, -118.22901), "773012": (34.08390, -118.22086),
    "773013": (34.08374, -118.22076), "764424": (34.17878, -118.39469),
    "769388": (34.11027, -118.33441), "716328": (34.06664, -118.25397),
    "717819": (34.18784, -118.47407), "769941": (34.20699, -118.20237),
    "760987": (34.15359, -118.34043), "718204": (34.15541, -118.29575),
    "718045": (34.06712, -118.23973), "769418": (34.12659, -118.34465),
    "768066": (34.15118, -118.37480), "772140": (34.16498, -118.47493),
    "773927": (34.15262, -118.28034), "760024": (34.15930, -118.46483),
    "774012": (34.14769, -118.20137), "774011": (34.14747, -118.20123),
    "767609": (34.18555, -118.21733), "769359": (34.15660, -118.42216),
    "760650": (34.07505, -118.23256), "716956": (34.10658, -118.25544),
    "769831": (34.20663, -118.20101), "761604": (34.15407, -118.28711),
    "717495": (34.15664, -118.41326), "716554": (34.15597, -118.26660),
    "773953": (34.15522, -118.29344), "767470": (34.15699, -118.22436),
    "716955": (34.09579, -118.24427), "764949": (34.12881, -118.34684),
    "773954": (34.15544, -118.29344), "767366": (34.21216, -118.47341),
    "769444": (34.15555, -118.43908), "773939": (34.15297, -118.37226),
    "774067": (34.15362, -118.28441), "769443": (34.15574, -118.43931),
    "767750": (34.09335, -118.20635), "767751": (34.09335, -118.20616),
    "767610": (34.18555, -118.21766), "773880": (34.15367, -118.34840),
    "764766": (34.13338, -118.35350), "717497": (34.15685, -118.41456),
    "717490": (34.14745, -118.37124), "717491": (34.14761, -118.37110),
    "717492": (34.15459, -118.37935), "717493": (34.15434, -118.39618),
    "765176": (34.13286, -118.35135), "717498": (34.15571, -118.43273),
    "717499": (34.15666, -118.44808), "765171": (34.16789, -118.46896),
    "718064": (34.11296, -118.24489), "718066": (34.12302, -118.22889),
    "765164": (34.07898, -118.28911), "769431": (34.15843, -118.45664),
    "769430": (34.15818, -118.45658), "717610": (34.17886, -118.39497),
    "767053": (34.17091, -118.46775), "767621": (34.13486, -118.22969),
    "772596": (34.17126, -118.50495), "772597": (34.17109, -118.50495),
    "767350": (34.18011, -118.47045), "767351": (34.18022, -118.47022),
    "716571": (34.20000, -118.40337), "773023": (34.05773, -118.24348),
    "767585": (34.16556, -118.22432), "773024": (34.05759, -118.24357),
    "717483": (34.11684, -118.33698), "718379": (34.14224, -118.27812),
    "717481": (34.10634, -118.32826), "717480": (34.10478, -118.32497),
    "717486": (34.12974, -118.34809), "764120": (34.20164, -118.40366),
    "772151": (34.16928, -118.49872), "718371": (34.09017, -118.23849),
    "717489": (34.13876, -118.36438), "717488": (34.13561, -118.36006),
    "717818": (34.17220, -118.46753), "718076": (34.16339, -118.22530),
    "718072": (34.14910, -118.22570), "767455": (34.14347, -118.22704),
    "767454": (34.14352, -118.22733), "761599": (34.14226, -118.27786),
    "717099": (34.15648, -118.24674), "773916": (34.15247, -118.28520),
    "716968": (34.16588, -118.29809), "769467": (34.15451, -118.39699),
    "717576": (34.15559, -118.29570), "717573": (34.15384, -118.32500),
    "717572": (34.15351, -118.32751), "717571": (34.15326, -118.35921),
    "717570": (34.15302, -118.35921), "764760": (34.13401, -118.35506),
    "718089": (34.12769, -118.27372), "769847": (34.20983, -118.22351),
    "717608": (34.17154, -118.38812), "767523": (34.11439, -118.24209),
    "716942": (34.05930, -118.21451), "718090": (34.14847, -118.27969),
    "769867": (34.21846, -118.23931), "717472": (34.10045, -118.31601),
    "717473": (34.10054, -118.31581), "759591": (34.11521, -118.26825),
    "764781": (34.16037, -118.47012), "765099": (34.16378, -118.47224),
    "762329": (34.13904, -118.22862), "716953": (34.09458, -118.24279),
    "716951": (34.08581, -118.23182), "767509": (34.11059, -118.24819),
    "765182": (34.06491, -118.25126), "769358": (34.15679, -118.42222),
    "772513": (34.06871, -118.23661), "716958": (34.11167, -118.26501),
    "718496": (34.15403, -118.34232), "769346": (34.15677, -118.40424),
    "773904": (34.15641, -118.30266), "718499": (34.15469, -118.31253),
    "764853": (34.06461, -118.25102), "761003": (34.15546, -118.30841),
    "717502": (34.16521, -118.47484), "759602": (34.12199, -118.27178),
    "717504": (34.16519, -118.49166), "763995": (34.21979, -118.40931),
    "717508": (34.17112, -118.51814), "765265": (34.18529, -118.47395),
    "773996": (34.14511, -118.21587), "773995": (34.14483, -118.21587),
    "717469": (34.09710, -118.31366), "717468": (34.09699, -118.31381),
    "764106": (34.17169, -118.38801), "717465": (34.09373, -118.30907),
    "764794": (34.16028, -118.46808), "717466": (34.09359, -118.30918),
    "717461": (34.08558, -118.30174), "717460": (34.08571, -118.30161),
    "717463": (34.09004, -118.30590), "717462": (34.08993, -118.30607),
    "769345": (34.15655, -118.40441), "716943": (34.05987, -118.21492),
    "772669": (34.07828, -118.22834), "717582": (34.15646, -118.26092),
    "717583": (34.15627, -118.25506), "717580": (34.15620, -118.26359),
    "716949": (34.08406, -118.22974), "717587": (34.15402, -118.23893),
    "772178": (34.16903, -118.49885), "717585": (34.15564, -118.24188),
    "716939": (34.04301, -118.21724), "768469": (34.13583, -118.35993),
    "764101": (34.16421, -118.38246), "767554": (34.11966, -118.23143),
    "773975": (34.14584, -118.22251), "773974": (34.14559, -118.22251),
    "717510": (34.17128, -118.51976), "717513": (34.17339, -118.53680),
    "717825": (34.22164, -118.47307), "767495": (34.10377, -118.24992),
    "767494": (34.10377, -118.24962), "717821": (34.20112, -118.47361),
    "717823": (34.20264, -118.47326), "717458": (34.08265, -118.29755),
    "717459": (34.08294, -118.29729), "769926": (34.21356, -118.23113),
    "764858": (34.15270, -118.37540), "717450": (34.07488, -118.27362),
    "717452": (34.07502, -118.27356), "717453": (34.07696, -118.28093),
    "759772": (34.17115, -118.30539), "717456": (34.08102, -118.29325),
    "771673": (34.07787, -118.22871), "772167": (34.16526, -118.47985),
    "769372": (34.10270, -118.31730), "774204": (34.15397, -118.34172),
    "769806": (34.19638, -118.18442), "717590": (34.14929, -118.23182),
    "717592": (34.14604, -118.22430), "717595": (34.14163, -118.18290),
    "772168": (34.16542, -118.47985), "718141": (34.15133, -118.37456),
    "769373": (34.10262, -118.31747),
}

# ── 4. Build sensor list with real coordinates ────────────────────────────
def get_color(c):
    if c < 0.25: return "#22c55e"
    if c < 0.45: return "#eab308"
    if c < 0.65: return "#f97316"
    return "#ef4444"

sensors = []
lats, lngs = [], []
for idx in range(n_sensors):
    sid = sensor_ids[idx]
    if sid in REAL_COORDS:
        lat, lng = REAL_COORDS[sid]
    else:
        # Fallback (should not happen for the standard 207 METR-LA sensors)
        lat, lng = 34.05 + np.random.normal(0, 0.05), -118.30 + np.random.normal(0, 0.05)
        print(f"  WARNING: sensor {sid} (idx {idx}) missing from REAL_COORDS, using fallback")
    c = float(congestion[idx])
    sensors.append({
        "id": idx,
        "sensor_id": sid,
        "lat": round(lat, 5),
        "lng": round(lng, 5),
        "avg_speed": round(float(mean_speed[idx]), 2),
        "congestion": round(c, 3),
        "color": get_color(c),
    })
    lats.append(lat)
    lngs.append(lng)

lats = np.array(lats)
lngs = np.array(lngs)

# ── 5. Build edges from adjacency matrix ──────────────────────────────────
# Keep edges where: adjacency weight > threshold AND physical distance < max_dist
# This gives us only the actual road connections
ADJ_WEIGHT_THRESHOLD = 0.1   # include edges with any meaningful weight
MAX_DIST_DEG = 0.04           # ~4km — skip very long cross-city connections

cos_lat = np.cos(np.radians(np.mean(lats)))

edges = []
seen = set()
for i in range(n_sensors):
    for j in range(n_sensors):
        if i >= j: continue
        w = max(adj[i, j], adj[j, i])
        if w < ADJ_WEIGHT_THRESHOLD: continue
        dlat = abs(lats[i] - lats[j])
        dlng = abs(lngs[i] - lngs[j]) * cos_lat
        dist = np.sqrt(dlat**2 + dlng**2)
        if dist > MAX_DIST_DEG: continue
        edge_key = (min(i, j), max(i, j))
        if edge_key not in seen:
            seen.add(edge_key)
            edges.append([int(i), int(j)])

print(f"Generated {len(sensors)} sensors, {len(edges)} edges")
print(f"Lat range: {min(lats):.4f} – {max(lats):.4f}")
print(f"Lng range: {min(lngs):.4f} – {max(lngs):.4f}")

# ── 6. Write output ──────────────────────────────────────────────────────
output = {"sensors": sensors, "edges": edges}

for out in ["frontend-observable/src/sensor-locations.json", "frontend/public/sensor-locations.json"]:
    os.makedirs(os.path.dirname(out), exist_ok=True)
    with open(out, "w") as f:
        json.dump(output, f)
    print(f"Wrote → {out} ({os.path.getsize(out)/1024:.1f} KB)")
